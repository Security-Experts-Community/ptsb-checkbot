# Телеграмм-бот для проверки файлов и ссылок в ptsb

## Содержание
- [Описание проекта](#описание-проекта)
- [Требования](#требования)
- [Установка приложения](#установка-приложения)
- [Удаление приложения](#удаление-приложения)
- [Изменение конфигурации приложения](#изменение-конфигурации-приложения)
- [Обновление приложения](#обновление-приложения)
- [Руководство администратора](#руководство-администратора)
- [Руководство пользователя](#руководство-пользователя)
- [Лицензия](#лицензия)
- [Отказ от обязательств](#отказ-от-обязательств)
- [Авторы](#авторы)
- [Контакты](#контакты)

## Описание проекта
Приложение представляет из себя `docker`-контейнер, внутри которого запускается телеграм бот. Телеграм бот представляет из себя пользовательский интерфейс для проверки объектов в песочнице через публичный API. Пользователи могут проверять как файлы, так и ссылки, при этом поддерживается возможность указания паролей при проверке зашифрованных файлов. А сами файлы могут быть пересланы боту без необходимости скачивания их на устройство пользователя.

Внутри приложения реализована ролевая модель взаимодействия с ботом, а также отдельная пользовательская модель для взаимодействия с песочницей.

Возможные действия администратора бота:
- Создание пользователя
- Блокировка пользователя
- Разблокировка пользователя
- Удаление пользователя
- Получение бэкапа БД приложения
- Проверка состояния API песочницы
- Отправка файлов на проверку
- Отправка ссылок на проверку
- Получение информации о доступных проверках

Возможные действия пользователя бота:
- Отправка файлов на проверку
- Отправка ссылок на проверку
- Получение информации о доступных проверках

Возможные кастомизируемые параметры пользователей:
- Указание количества доступных проверок в день для этого пользователя
- Указание приоритета проверки заданий от этого пользователя
- Указание возможности получения пользователем ссылок на задания в системе ptsb

## Требования
- Приложение запускается внутри `docker`-контейнера. Для корректной работы требуется установленное ПО `docker` и входящий в него модуль `compose`.
- Сетевая связность между хостом, где установлен бот и системой ptsb по порту `443/https`.
- Доступ до `https://api.telegram.org` от хоста, на котором будет развёрнуто приложение, чтобы взаимодействовать с Public API Telegram.
- Аккаунт в Telegram.


## Установка приложения

### 1. Создание бота в Telegram
Для того, чтобы Вы могли взаимодействовать с Telegram-ботом, его необходимо создать и получить `токен` доступа к нему. Через этот `токен` бот будет осуществлять взаимодействие с публичным API Telegram.

1. Перейти в диалог с [BotFather](https://t.me/BotFather) - официльным Telegram-ботом для создания новых ботов.
2. Отправить ему команду `/start`
3. Из предложенного списка выбрать `/newbot` и нажать ЛКМ
4. Бот запросит имя для создамаемого Вами бота. Здесь можно ввести любое название в рамках цензуры. Оно не обязательно должно быть уникальным, это будет то имя, которое отображается как имя Отправителя в Telegram.
5. Бот запросит ввести `username` (ссылку) для создаваемого бота. Она обязательно должна быть уникальной, а также заканчиваться на `bot`. Если введенное значение не удовлетворит условиям, BotFater перезапросит ввод `username` для Вашего бота.
6. В случае, если всё было указано верно, в ответ на `username` BotFather вернёт:
    - Ссылку на Вашего бота. Она будет выглядеть как `t.me/<username>`. Рекомендуется перейти по ней и нажать "Запустить", чтобы бот отобразился в Ваших диалогах.
    - Токен доступа к Вашему боту. Его можно скопировать нажатием на текст токена. Токен понадобится в дальнейшем при настройке приложения. <br>
    ***Внимание!*** Никому не сообщайте токен от Вашего бота ни при каких условиях. Если Вам кажется, что токен скомпрометирован - удалите бота через BotFather и создайте нового. При этом, все прочие параметры приложения останутся без изменений, т.к. бот - только способ обращения приложения к пользователю через API Telegram. 

На этом создание бота завершено. При желании Вы можете изменить боту имя или установить аватарку.

---
### 2. Получение TG ID администратора бота
На этом шаге необходимо получить Ваш `Telegram ID`, чтобы занести его в БД пользователей. Таким образом, сразу после запуска бота - Вы будете довернным пользователем в приложении с административными правами:
1. Перейдите в бота [Get My ID](https://t.me/getmyid_bot) для получения Вашего ID.
2. Отправьте боту команду `/start`. Бот пришлет в ответ сообщение, в котором будет указано `Your user ID`. Скопируйте или запомните это числовое значение

На этом работа с `Telegram ID` завершена.

---
### 3. Настройка PT Sandbox
Для настройки песочницы требутся выполнить 2 действия - создать токен доступа и создать источник для проверки объектов.
1. Перейдите в веб-интерфейс системы ptsb -> вкладка `Система` -> раздел `Токены доступа`.
2. Нажмите кнопку `Создать токен доступа`.
3. В разрешенных действиях укажите **Проверка с параметрами источника**.
4. Нажмите кнопку `Создать` и после сохраните полученное значение токена.
5. Перейдите в веб-интерфейс системы ptsb -> вкладка `Источники`.
6. Нажмите кнопку `Добавить источник`.
7. В типе источника выберите **API с выбранными параметрами проверки**.
8. В разделе `Токен доступа` укажите созданный ранее токен.
9. Настройте источник по своему усмотрению.

На этом настройка песочницы завершена.

---
### 4. Скачивание проекта
1. Для скачивания исходного кода зайдите на Linux-хост.
2. Скачайте исходный код при помощи `git`:
    ```bash
    git clone https://github.com/kaifuss/ptsb-checkbot.git
    ```
    Или как ZIP-архив по ссылке:
    ```bash
    https://github.com/kaifuss/ptsb-checkbot/archive/refs/heads/main.zip
    ```

---
### 5. Установка и настройка
Уставнока должна выполняться с правами sudo.

1. Перейдите в корневую директорию скачанного проекта:
    ```bash
    cd ptsb-checkbot
    ```
2. Сделайте файл `install.sh` исполняемым:
    ```bash
    chmod +x install.sh
    ```
3. Запустите установку приложения через `install.sh`, находясь всё в той же директории:
    ```bash
    sudo ./install.sh
    ```
    Скрипт начнет запрашивать параметры, согласно которым будет настроено приложение. Если не вводить ничего и нажать `Enter` - будет сохранено значение по умолчанию.

4. Для настройки Telegram-бота необходимо ввести токен, который был получен на предыдущих шагах. Достаточно просто скопировать и вставить токен в запрашиваемой строке:
    ```bash
    Input value for parameter TG_BOT_TOKEN (текущее: ''):
    ```
5. Для создания профиля пользователя администратора навдо ввети `Telegram ID` пользователя, который был получен ранее (Ваш линый TG ID):
    ```bash
    Input value for parameter FIRST_BOT_ADMIN_ID (текущее: ''):
    ```
6. Для отправки объектов на проверку, а также перехода к страницам созданных заданий (тем пользователям, кому это доступно) необходимо ввести адрес веб-интерфейса, по которому доступен ptsb. Если используется FQDN - вводите FQDN вместо IP. Если используется отказоустойчивый кластер - вводите адрес по которому доступен отказоустойчивый кластер.
    ```bash
    Input value for parameter PTSB_ROOT_ADDR (текущее: '')
    ```
7. Для отпрвки объектов на проверку требуется указать токен доступа к ptsb, по которому приложение будет авторизовываться в системе, а песочница будет ассоциировать запрос с настроенным ранее источником API.
    ```bash
    Input value for parameter PTSB_TOKEN (текущее: '')
    ```
8. Вы можете указать, необходимо ли боту проверять валидность SSL соединения, которое устанавливается с песочницей вовремя отправки API-запроса на проверку. Ввод `0`- не проверять корректность SSL соединения, `1` - проверять. При вводе `0` также продолжает устанавливаться защищенное соединение по протоколу HTTPS, но сертификат не проверяется:
    ```bash
    Input value for parameter VERIFY_SSL_CONNECTIONS (текущее: '')
    ``` 
9. После ввода последнего параметра начнется сборка docker-образа и установка приложения. По завершении установки выведутся сообщения:
    ```bash
     ✔ Service ptsb-checkbot    Built
     ✔ Container ptsb-checkbot  Started
    ```


## Удаление приложения
Удаление приложение необходимо производить также при помощи sudo:
1. Перейдите в корневую директорию скачанного проекта:
    ```bash
    cd ptsb-checkbot
    ```
2. Сделайте файл `uninstall.sh` исполняемым:
    ```bash
    chmod +x uninstall.sh
    ```
3. Запустите удаление приложения через `uninstall.sh`, находясь всё в той же директории:
    ```bash
    sudo ./uninstall.sh
    ```
По окончании удаления скрипт выведет информацию о том, что удаление docker-контейнера и образа docker-контейнера завершено.


## Изменение конфигурации приложения
Изменение конфигурации может потебоваться, если Вы хотите поменять какие-то параметры. Например, токен Telegram-бота в связи с созданием нового бота или токен доступа к ptsb. При этом, переустановки не происходит, меняются только системные параметры.<br>
***Примечание:*** Менять `FIRST_BOT_ADMIN_ID` не рекомендуется, т.к. это создаст нового пользователя с правами главного администратора. Выполняйте только в том случае, если потеряли доступ к страрому аккаунту.

Изменение параметров производится с правами sudo:
1. Перейдите в корневую директорию скачанного проекта:
    ```bash
    cd ptsb-checkbot
    ```
2. Запустите установку через `install.sh`, находясь всё в той же директории:
    ```bash
    sudo ./install.sh
    ```
3. Введите новые значения для тех параметров, которые требуется изменить. Если какой-то параметр менять не нужно, то просто нажмите `Enter` и значение останется равным тому, что сохранено в скобках. 
4. Скрипт укажет, что образ контейнера уже найден. Введите `update` для переконфигурации основных параметров приложения:
    ```bash
    Image of 'ptsb-checkbot' already exists. Do you want to update parameters of application or fully rebuild? (update/rebuild): update
    ```
    
    По завершении переконфигурации выведутся сообщения:
    ```bash
     ✔ Service ptsb-checkbot   Built
     ✔ Container ptsb-checkbot  Started
    ```

Переконифгурация приложения завершена.

## Обновление приложения
Обновление может потребоваться, если вышла новая версия. В этом случае происходит пересборка приложения. В случае скачивания новой версии через `git clone` может перезаписаться файл со старыми параметрами приложения. Перед установкой новой версии рекомендуется выписать старые параметры, например, через `cat config/default.env`.

Обновление производится при помощи sudo прав:
1. Перейдите в корневую директорию скачанного проекта:
    ```bash
    cd ptsb-checkbot
    ```
2. Запустите установку через `install.sh`, находясь всё в той же директории:
    ```bash
    sudo ./install.sh
    ```
3. Скрипт укажет, что образ контейнера уже найден. Введите `rebuild` для обновления приложения:
    ```bash
    Image of 'ptsb-checkbot' already exists. Do you want to update parameters of application or fully rebuild? (update/rebuild): rebuild
    ```
    
    По завершении пересборки приложения выведутся сообщения:
    ```bash
    ✔ Network ptsb-checkbot  Created
    ✔ Container ptsb-checkbot  Started
    ```

Обновление приложения завершено.

## Руководство администратора
Административные действия внутри приложения делятся на действия по управлению пользователями и действия по взамиодействию с песочницей.

### 1. Управление пользователями
Для перехода к управлению пользователями необходимо нажать кнопку `👤 Управление пользователями`.

---
#### Создание пользователя
Для создания пользователя необходимо нажать кнопку `➕ Добавить пользователя по ID`, после чего начнется заполнение параметров пользователя приложения (бота):

1. Ввод `TG ID`.
    
    На этом шаге неообходимо ввести ID пользователя, который просит, чтобы его добавили в бота. Этот ID может сообщить ему сам бот, если пользователь отправит ему команду `/start`. <br>
    ***Примечание:*** Во избежание путаницы просите, чтобы пользователи пересылали Вам приветственное сообщение от бота.
2. Ввод роли пользователя.

    На этом шаге необходимо указать, какая роль будет доступна пользователю. Бот в ответном сообщении укажет список поддерживаемых ролей и их описание.
3. Ввод комментария.
    
    На этом шаге можно указать любую полезную информацию о пользователе, которая поможет в последствии его как-либо идентифицировать.
4. Ввод количества проверок в день.
    
    На этом шаге нужно указать целое число, которое будет обозначать количество возможных проверок в день, которые может создать пользователь. Считаются как проверки ссылок, так и проверки файлов.
5. Ввод приоритета проверки.
    
    На этом шаге необходимо указать приоритет проверки объектов от этого пользователя. Используется градация согласно официальной документации песочницы.
6. Указание возможности получать ссылки.

    На этом шаге нужно указать, будет ли этот пользователь получать ссылки на страницы заданий в системе ptsb. Если Вы не хотите, чтобы пользователь знал адрес песочницы Вашей организации, запретите пользователю получать ссылки. Для людей, кому адрес песочницы доступен и известен, можете разрешить получать ссылки.

    На этом создание пользователя завершено.

---
#### Получение информации о пользователе
Для получения информации о профиле пользователя внутри бота необходимо нажать кнопку `ℹ️ Подробная информация о пользователе по ID`, после чего отправить боту `TG ID` пользователя.

В ответ на это сообщение бот вернет всю доступную информацию по пользователю, включающую в себя как сведения о доступе к боту, так и профиль взаимодействия с песочницей.

---
#### Блокировака пользователя в боте
Для блокировки пользователя внутри бота необходимо нажать кнопку `🔒 Заблокировать по ID`, после чего отправить боту `TG ID` пользователя.

Заблокированный пользователь теряет возможность отправлять файлы и ссылки на проверку, при этом, его профиль продолжает существовать в боте.

---
#### Разблокировака пользователя в боте
Для разблокировки пользователя внутри бота необходимо нажать кнопку `🔓 Разблокировать по ID`, после чего отправить боту `TG ID` пользователя. 

Разблокированный пользователь снова получает возможность отправлять файлы и ссылки на проверку.

---
#### Удаление пользователя из бота
Для удаления пользователя из бота необходимо нажать кнопку `🗑 Удалить пользователя по ID`, после чего отправить боту `TG ID` пользователя.

Удаленный пользователь теряет возможность отправлять файлы и ссылки на проверку, при этом, его профиль больше не существует в боте.

---
### 2. Взаимодействие с песочницей
Для перехода к взаимодействию с песочнией необходимо нажать кнопку `🏖 Взаимодействие с песочницей`.

---
#### Проверка состояния API
Для проверки состояния API необходимо нажать кнопку `✅ Проверить состояние API`. Проверка занимает до `10 секунд`, поэтому проявите терпение. Это время необходимо для исключения ошибок, связанных с таймаутом подключения.

В ответ бот пришлет соощбение с информацией о том, доступен ли API песочницы или нет. В случае известной ошибки, бот даст ее описание, благодаря чему Вы сможете ее решить. В случае, если ошибка неизвестна, бот также это подстветит.

---
### 3. Получение бэкапа и восстановление из резервной копии
Для перехода к меню управления приложением необходимо нажать кнопку "🗄 Получить бэкап БД".

---
#### Получение снепшота базы данных приложения
Для получения файла БД приложения, в котором содержится информация обо всех пользователях необходимо нажать кнопку `🗄 Получить бэкап БД`. В ответ на это действие, будет отправлен файл БД приложения, который содержит профили пользователей и профили взаимодействия с песочницей на текущий момент времени. В последствии этот файл можно будет использовать для восстановления приложения.<br>
***Примечание:*** Файл можно также использовать для переноса приложения на другой хост. Однако, при этом потребуется сначала установить приложение на новом хосте обычным путем из [Установка и настройка](#5-установка-и-настройка), а затем выполнить восстановление с файлом бэкапа БД. Рекомендуется также скопировать файл из директории `config/default.env` с настроками приложения.

---
#### Запуск приложения с восстановлением
1. Перейдите в корневую директорию скачанного проекта:
    ```bash
    cd ptsb-checkbot
    ```
2. Создайте директорию `ptsb-checkbot/database`, если она еще не существует:
    ```bash
    mkdir ptsb-checkbot/database
    ```
3. Перенесите в нее полученный ранее файл без изменения его названия:
    ```bash
    cp /path/to/kernel_base.db ptsb-checkbot/database
    ```
4. Сделайте файл `install.sh` исполняемым:
    ```bash
    chmod +x install.sh
    ```
5. Запустите установку приложения через `install.sh` с флагом `--backup_db=true`, находясь всё в той же директории:
    ```bash
    sudo ./install.sh --backup_db=true
    ```
6. Введите новые параметры приложения или оставьте их равными текущим.
7. Скрипт укажет, что образ контейнера уже найден. Введите `rebuild` для пересборки приложения с новой БД приложения:
    ```bash
    Image of 'ptsb-checkbot' already exists. Do you want to update parameters of application or fully rebuild? (update/rebuild): rebuild
    ```
    
    По завершении пересборки приложения выведутся сообщения:
    ```bash
    ✔ Network ptsb-checkbot  Created
    ✔ Container ptsb-checkbot  Started
    ```

## Руководство пользователя
Для перехода к взаимодействию с песочнией необходимо нажать кнопку `🏖 Взаимодействие с песочницей`.

---
### 1. Отправка файла на проверку
Для отправки файла на проверку нажать кнопку `📁 Отправить файл на проверку`. После чего начнется указание параметров проверки и загрузка файла в бота.

1. Сперва загрузите файл, который необходимо проверить. Вы также можете переслать сообщение от другого пользователя, при этом, скачивать его к себе на устройство не придется.<br>
    ***Примечение:*** Поддержживается загрузка 1 файла размером до 20 Мбайт. В случае, если отправить файл бОльшего размера, загрузить его бот не сможет - это ограничения телеграма. Если отправить больше 1 файла - бот возьмет только первых из них.
2. Введите пароли для проверки файла, если Вы знаете, что файл зашифрован. Поддерживается ввод до 5 паролей, каждый из которых отделяется от другого вводом с новой строки (`shift` + `enter` по-умолчанию для телеграма). Если паролей нет, нажмите кнопку `⏫ Отправить на проверку` и задание будет проверено без указания паролей.
3. Для получения результатов проверки периодически (но не чаще `10 секунд`) обновляйте статус задания нажатием кнопки `🔄 Обновить статус задания`. Если результаты проверки были получены - бот сообщит об этом и вернёт Вас в главное меню.


---
### 2. Отправка ссылки на проверку
Для перехода к взаимодействию с песочнией необходимо нажать кнопку `🔗 Отправить ссылку на проверку`.

1. Отправьте боту ссылку, которую необходимо проверить, указав ее текстом в сообщении.
2. Введите пароли для проверки файла, который скачается по этой ссылке, если Вы знаете, что файл зашифрован. Поддерживается ввод до 5 паролей, каждый из которых отделяется от другого вводом с новой строки (`shift` + `enter` по-умолчанию для телеграма). Если паролей нет, нажмите кнопку `⏫ Отправить на проверку` и задание будет проверено без указания паролей.
3. Для получения результатов проверки периодически (но не чаще `10 секунд`) обновляйте статус задания нажатием кнопки `🔄 Обновить статус задания`. Если результаты проверки были получены - бот сообщит об этом и вернёт Вас в главное меню.

---
### 3. Получение информации о себе
Для получения информации об оставшемся количестве проверок на сегодня необходимо нажать кнопку `📊 Получить сведения о проверках`.

В ответ на это бот вернет сообщение, в котором будет указана информация о количестве проверок, доступных для Вас.


## Лицензия
Shield: [![CC BY-NC 4.0][cc-by-nc-shield]][cc-by-nc]

This work is licensed under a
[Creative Commons Attribution-NonCommercial 4.0 International License][cc-by-nc].

[![CC BY-NC 4.0][cc-by-nc-image]][cc-by-nc]

[cc-by-nc]: https://creativecommons.org/licenses/by-nc/4.0/
[cc-by-nc-image]: https://licensebuttons.net/l/by-nc/4.0/88x31.png
[cc-by-nc-shield]: https://img.shields.io/badge/License-CC%20BY--NC%204.0-lightgrey.svg

p.s.
If we meet some day, and you think this stuff is worth it, you can buy me a beer in return.


## Отказ от обязательств
Автор не имеет отношения к компании Positive Technologies и не является её сотрудником. Также автор не несет ответственности за любые последствия от использования приложения на реальных инсталляциях. Ответственность лежит исключительно на конечном пользователе.

## Авторы
Кирилл Красновский - Full-fledged work on the project - [Github](https://github.com/kaifuss) <br>

И по традиции благодарю Романа за наставления и поддержку при разработке проекта - [Github](https://github.com/rberzh)

## Контакты
Для связи с автором проекта обращаться в tg: [@corgi_llama](https://t.me/corgi_llama)